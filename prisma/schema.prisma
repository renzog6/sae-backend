// filepath: sae-backend/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Base models
model User {
  id        Int      @id @default(autoincrement())
  name      String   @db.VarChar(25)
  email     String   @unique
  username  String?  @unique
  password  String
  role      Role     @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@map("users")
}

enum Role {
  USER
  ADMIN
}

// Company related models
model Company {
  id           Int     @id @default(autoincrement())
  cuit         String  @unique @db.VarChar(13) // 12-12345678-1
  name         String  @db.VarChar(255)
  businessName String? @db.VarChar(255)
  information  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  businessCategoryId Int?
  businessCategory   BusinessCategory?  @relation(fields: [businessCategoryId], references: [id])
  contacts           ContactLink[]
  addresses          Address[]
  employees          Employee[]
  documents          Document[]
  equipment          Equipment[]
  products           ProductCompany[]
  parts              PartOrderCompany[]
  HistoryLog         HistoryLog[]

  @@index([businessName])
  @@map("companies")
}

model BusinessCategory {
  id          Int     @id @default(autoincrement())
  name        String  @unique @db.VarChar(25)
  code        String? @unique
  information String?

  // Relations
  companies     Company[]
  subCategories BusinessSubCategory[]

  @@map("business_categories")
}

model BusinessSubCategory {
  id                 Int     @id @default(autoincrement())
  name               String  @db.VarChar(25)
  description        String?
  businessCategoryId Int

  // Relations
  businessCategory BusinessCategory @relation(fields: [businessCategoryId], references: [id])

  @@unique([businessCategoryId, name]) // evita duplicados dentro de la misma categor√≠a
  @@map("business_subcategories")
}

// Contact related models
model Contact {
  id          Int         @id @default(autoincrement())
  type        ContactType
  value       String
  label       String?
  information String?     @default("")

  // Relaciones polim√≥rficas
  contactLinks ContactLink[]

  @@map("contacts")
}

enum ContactType {
  EMAIL
  PHONE
  WHATSAPP
  TELEGRAM
  INSTAGRAM
  LINKEDIN
  OTHER
}

model ContactLink {
  id        Int     @id @default(autoincrement())
  contactId Int
  contact   Contact @relation(fields: [contactId], references: [id])

  companyId Int?
  company   Company? @relation(fields: [companyId], references: [id])

  personId Int?
  person   Person? @relation(fields: [personId], references: [id])

  @@index([companyId])
  @@index([personId])
  @@map("contact_links")
}

// Location related models
model Country {
  id      Int     @id @default(autoincrement())
  name    String  @unique @db.VarChar(25)
  isoCode String  @unique // ISO 3166-1 alpha-2 (ej: AR, US, ES)
  code    String? // C√≥digo num√©rico del pa√≠s

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  provinces Province[]

  @@index([isoCode])
  @@map("countries")
}

model Province {
  id   Int    @id @default(autoincrement())
  code String @unique
  name String @db.VarChar(25)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  countryId Int     @map("country_id")
  country   Country @relation(fields: [countryId], references: [id], onDelete: Cascade)
  cities    City[]

  @@index([countryId])
  @@map("provinces")
}

model City {
  id         Int    @id @default(autoincrement())
  name       String @db.VarChar(50)
  postalCode String @map("postal_code")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  provinceId Int       @map("province_id")
  province   Province  @relation(fields: [provinceId], references: [id], onDelete: Cascade)
  addresses  Address[]

  @@index([provinceId])
  @@index([postalCode])
  @@map("cities")
}

model Address {
  id        Int      @id @default(autoincrement())
  street    String?  @map("street") // Calle
  number    String?  @map("number") // N√∫mero
  floor     String?  @map("floor") // Piso
  apartment String?  @map("apartment") // Departamento
  latitude  Decimal? @db.Decimal(10, 7)
  longitude Decimal? @db.Decimal(10, 7)

  // Campos adicionales
  neighborhood String? @map("neighborhood") // Barrio
  reference    String? @map("reference") // Referencia
  isActive     Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  cityId Int  @map("city_id")
  city   City @relation(fields: [cityId], references: [id], onDelete: Cascade)

  // Polimorfismo simple: puede pertenecer a persona o empresa
  person   Person? @relation(fields: [personId], references: [id], onDelete: Cascade)
  personId Int?    @unique @map("person_id")

  company   Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyId Int?     @map("company_id")

  @@index([cityId])
  @@index([personId])
  @@index([companyId])
  @@map("addresses")
}

enum EmployeeStatus {
  ACTIVE
  SUSPENDED
  TERMINATED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

enum PersonStatus {
  ACTIVE
  INACTIVE
}

model Employee {
  id           Int            @id @default(autoincrement())
  employeeCode String?        @default("00000") // N√∫mero de legajo interno de la empresa
  information  String?
  status       EmployeeStatus @default(ACTIVE)
  hireDate     DateTime
  endDate      DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  // Relations
  companyId Int?
  company   Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  categoryId Int
  category   EmployeeCategory @relation(fields: [categoryId], references: [id])

  positionId Int
  position   EmployeePosition @relation(fields: [positionId], references: [id])

  personId Int    @unique
  person   Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  vacations        EmployeeVacation[]
  documents        Document[]
  inspections      Inspection[]
  EmployeeIncident EmployeeIncident[]
  HistoryLog       HistoryLog[]

  @@index([companyId])
  @@index([categoryId])
  @@index([positionId])
  @@index([companyId, categoryId])
  @@index([companyId, status])
  @@map("employees")
}

model EmployeeCategory {
  id          Int     @id @default(autoincrement())
  name        String  @db.VarChar(25)
  code        String? @unique
  information String?
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employees Employee[]

  @@index([name])
  @@index([code])
  @@map("employee_categories")
}

model EmployeePosition {
  id          Int     @id @default(autoincrement())
  name        String  @db.VarChar(25)
  code        String? @unique
  information String?
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employees Employee[]

  @@index([name])
  @@index([code])
  @@map("employee_positions")
}

model EmployeeVacation {
  id             Int          @id @default(autoincrement())
  detail         String?
  days           Int          @default(0)
  year           Int          @default(0)
  startDate      DateTime
  endDate        DateTime
  settlementDate DateTime     @default(now())
  type           VacationType @default(TAKEN)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employeeId Int
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([startDate])
  @@index([endDate])
  @@map("employee_vacations")
}

enum VacationType {
  ASSIGNED // D√≠as nuevos acreditados (carga administrativa)
  TAKEN // D√≠as efectivamente tomados  
}

model Person {
  id            Int            @id @default(autoincrement())
  firstName     String         @db.VarChar(25)
  lastName      String         @db.VarChar(25)
  birthDate     DateTime?
  dni           String?        @unique @db.VarChar(8) // dni no se modifica ni se traduce
  cuil          String?        @unique @db.VarChar(13) // cuil no se modifica ni se traduce 12-12345678-1
  gender        Gender?
  maritalStatus MaritalStatus?
  information   String?
  status        PersonStatus?  @default(ACTIVE)
  address       Address?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relations
  contacts     ContactLink[]
  employee     Employee?
  relatives    Family[]      @relation("Person_Family")
  isRelativeOf Family[]      @relation("Relative_Person")
  HistoryLog   HistoryLog[]

  @@index([lastName])
  @@index([firstName])
  @@map("persons")
}

model Family {
  id           Int    @id @default(autoincrement())
  relationship String @map("relacion")

  // Relations
  personId Int
  person   Person @relation("Person_Family", fields: [personId], references: [id], onDelete: Cascade)

  relativeId Int
  relative   Person @relation("Relative_Person", fields: [relativeId], references: [id], onDelete: Cascade)

  @@index([personId])
  @@index([relativeId])
  @@map("family_relationships")
}

model Document {
  id          Int      @id @default(autoincrement())
  filename    String // Nombre original del archivo
  mimetype    String // Tipo MIME (ej: application/pdf, image/png)
  size        Int // Tama√±o en bytes
  path        String // Ruta donde se guarda el archivo (o URL en S3/MinIO)
  description String? // Descripci√≥n opcional
  uploadedAt  DateTime @default(now())

  // Relaciones opcionales
  employeeId Int?
  companyId  Int?

  employee Employee? @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  company  Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("documents")
}

// Inspection related models
model Inspection {
  id          Int      @id @default(autoincrement())
  date        DateTime @default(now())
  description String?  @db.Text
  observation String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  equipmentId Int       @map("equipment_id")
  equipment   Equipment @relation(fields: [equipmentId], references: [id])

  employeeId Int      @map("employee_id")
  employee   Employee @relation(fields: [employeeId], references: [id])

  inspectionTypeId Int?            @map("inspection_type_id")
  inspectionType   InspectionType? @relation(fields: [inspectionTypeId], references: [id])

  @@index([equipmentId])
  @@index([employeeId])
  @@index([inspectionTypeId])
  @@map("inspections")
}

model InspectionType {
  id          Int     @id @default(autoincrement())
  name        String  @unique @db.VarChar(25)
  description String?

  // Relations
  inspections Inspection[]

  @@map("inspection_types")
}

model Presentation {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(25)
  code        String?   @unique @db.VarChar(10)
  information String?
  Product     Product[]

  @@map("presentations")
}

model Tire {
  id          Int     @id @default(autoincrement())
  size        String? @db.VarChar(25)
  information String? @db.VarChar(255)

  @@map("tires")
}

model Brand {
  id          Int     @id @default(autoincrement())
  name        String  @unique @db.VarChar(25)
  information String?
  code        String  @unique
  isActive    Boolean @default(true)

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  Part           Part[]
  Product        Product[]
  EquipmentModel EquipmentModel[]

  @@index([name])
  @@map("brands")
}

model Unit {
  id           Int     @id @default(autoincrement())
  name         String  @db.VarChar(25)
  abbreviation String  @unique
  isActive     Boolean @default(true)

  @@index([name])
  @@map("units")
}

// Modelo general para eventos diversos
model HistoryLog {
  id          Int           @id @default(autoincrement())
  title       String // T√≠tulo del evento
  description String? // Descripci√≥n detallada
  type        HistoryType // Tipo de evento
  severity    SeverityLevel @default(INFO)
  eventDate   DateTime      @default(now()) // Cu√°ndo ocurri√≥ el evento
  createdAt   DateTime      @default(now())

  // Relaciones polim√≥rficas - puede pertenecer a m√∫ltiples entidades
  employeeId  Int?
  companyId   Int?
  equipmentId Int?
  personId    Int?

  // Relations
  employee  Employee?  @relation(fields: [employeeId], references: [id])
  company   Company?   @relation(fields: [companyId], references: [id])
  equipment Equipment? @relation(fields: [equipmentId], references: [id])
  person    Person?    @relation(fields: [personId], references: [id])

  // Metadata adicional
  metadata String? // Datos espec√≠ficos del evento en JSON (stored as string)

  @@index([employeeId])
  @@index([companyId])
  @@index([equipmentId])
  @@index([personId])
  @@index([type])
  @@index([eventDate])
  @@map("history_logs")
}

enum HistoryType {
  EMPLOYEE_ILLNESS // Enfermedad empleado
  EMPLOYEE_WARNING // Llamado de atenci√≥n
  EMPLOYEE_ACHIEVEMENT // Logro/reconocimiento
  EMPLOYEE_HIRE // Contrataci√≥n de empleado
  VACATION_ASSIGNED // Vacaciones asignadas
  VACATION_TAKEN // Vacaciones tomadas
  COMPANY_REMINDER // Recordatorio empresa
  COMPANY_EVENT // Evento corporativo
  EQUIPMENT_MAINTENANCE // Mantenimiento equipo
  EQUIPMENT_ACCIDENT // Accidente equipo
  EQUIPMENT_REPAIR // Reparaci√≥n
  PERSONAL_EVENT // Evento personal
  GENERAL_NOTE // Nota general
}

enum SeverityLevel {
  INFO // Informativo
  WARNING // Advertencia
  CRITICAL // Cr√≠tico
  SUCCESS // Exitoso
}

// Tablas espec√≠ficas para casos que requieren estructura fija
model EmployeeIncident {
  id          Int                  @id @default(autoincrement())
  type        EmployeeIncidentType
  description String
  startDate   DateTime? // Fecha inicio enfermedad/incidente
  endDate     DateTime? // Fecha fin
  doctorNote  Boolean              @default(false) // ¬øTiene certificado m√©dico?
  paidLeave   Boolean              @default(false) // ¬øEs licencia paga?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employeeId Int
  employee   Employee @relation(fields: [employeeId], references: [id])

  @@index([employeeId])
  @@index([type])
  @@index([startDate])
  @@map("employee_incidents")
}

enum EmployeeIncidentType {
  SICK_LEAVE // Licencia por enfermedad
  DISCIPLINARY // Medida disciplinaria
  WARNING // Llamado de atenci√≥n formal
  ACCIDENT // Accidente laboral
  FAMILY_EMERGENCY // Emergencia familiar
  UNJUSTIFIED_ABSENCE // Ausencia sin justificar
  VACATION_LEAVE // Licencia por vacaciones
}

model EquipmentMaintenance {
  id          Int             @id @default(autoincrement())
  type        MaintenanceType
  description String
  cost        Decimal?        @db.Decimal(10, 2)
  startDate   DateTime
  endDate     DateTime?
  technician  String? // Nombre del t√©cnico/taller
  warranty    Boolean         @default(false) // ¬øEn garant√≠a?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  equipmentId Int
  equipment   Equipment @relation(fields: [equipmentId], references: [id])

  @@index([equipmentId])
  @@index([type])
  @@index([startDate])
  @@map("equipment_maintenance")
}

enum MaintenanceType {
  PREVENTIVE // Mantenimiento preventivo
  CORRECTIVE // Mantenimiento correctivo
  ACCIDENT_REPAIR // Reparaci√≥n por accidente
  ROUTINE_CHECK // Revisi√≥n rutinaria
}

// ====================
// üîß EQUIPOS
// ====================

model Equipment {
  id           Int             @id @default(autoincrement())
  internalCode String?         @unique // C√≥digo interno (ej: EQ-00123)
  name         String?         @db.VarChar(50)
  description  String?
  observation  String?
  year         Int?
  licensePlate String?         @unique
  chassis      String?         @unique
  engine       String?         @unique
  color        String?
  diesel       Boolean?
  status       EquipmentStatus @default(ACTIVE)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Relaciones
  companyId Int?     @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])

  categoryId Int?               @map("category_id")
  category   EquipmentCategory? @relation(fields: [categoryId], references: [id])

  typeId Int?           @map("type_id")
  type   EquipmentType? @relation(fields: [typeId], references: [id])

  modelId Int?            @map("model_id")
  model   EquipmentModel? @relation(fields: [modelId], references: [id])

  parts                EquipmentPart[]
  inspections          Inspection[]
  EquipmentMaintenance EquipmentMaintenance[]
  HistoryLog           HistoryLog[]

  @@index([companyId])
  @@index([categoryId])
  @@index([typeId])
  @@index([modelId])
  @@index([year])
  @@map("equipment")
}

enum EquipmentStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
  RETIRED
}

// --------------------
// Categor√≠as / Tipos / Modelos
// --------------------

model EquipmentCategory {
  id          Int     @id @default(autoincrement())
  code        String? @unique
  name        String  @unique @db.VarChar(25)
  description String?

  // Relaciones
  equipment Equipment[]
  types     EquipmentType[]

  @@map("equipment_categories")
}

model EquipmentType {
  id          Int                @id @default(autoincrement())
  code        String?            @unique
  name        String             @db.VarChar(25)
  description String?
  categoryId  Int?               @map("category_id")
  // Relaciones
  equipment   Equipment[]
  category    EquipmentCategory? @relation(fields: [categoryId], references: [id])
  models      EquipmentModel[]

  @@unique([name, categoryId])
  @@index([categoryId])
  @@map("equipment_types")
}

model EquipmentModel {
  id          Int     @id @default(autoincrement())
  code        String? @unique
  name        String  @db.VarChar(25)
  year        Int?
  description String?
  typeId      Int?    @map("type_id")
  brandId     Int?    @map("brand_id")

  // Relaciones
  brand     Brand?               @relation(fields: [brandId], references: [id])
  type      EquipmentType?       @relation(fields: [typeId], references: [id])
  equipment Equipment[]
  parts     EquipmentModelPart[]

  @@index([typeId])
  @@index([brandId])
  @@map("equipment_models")
}

// ====================
// üß± PARTES
// ====================

model Part {
  id          Int      @id @default(autoincrement())
  code        String?  @unique
  name        String?  @db.VarChar(25)
  description String?
  information String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relaciones
  brandId Int?
  brand   Brand? @relation(fields: [brandId], references: [id])

  categoryId Int?
  category   PartCategory? @relation(fields: [categoryId], references: [id])

  companies  PartOrderCompany[]
  models     EquipmentModelPart[]
  equipments EquipmentPart[]

  @@index([code])
  @@index([name])
  @@index([brandId])
  @@map("parts")
}

model PartCategory {
  id          Int      @id @default(autoincrement())
  code        String?  @unique
  name        String   @unique @db.VarChar(25)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  parts Part[]

  @@map("part_categories")
}

// Relaciones N:M extendidas
model PartOrderCompany {
  companyId Int
  partId    Int
  price     Decimal? @db.Decimal(10, 2)
  stock     Int?     @default(0)
  createdAt DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id])
  part    Part    @relation(fields: [partId], references: [id])

  @@id([companyId, partId])
  @@map("part_company")
}

model EquipmentModelPart {
  modelId   Int
  partId    Int
  createdAt DateTime @default(now())

  model EquipmentModel @relation(fields: [modelId], references: [id])
  part  Part           @relation(fields: [partId], references: [id])

  @@id([modelId, partId])
  @@map("part_equipment_model")
}

model EquipmentPart {
  equipmentId Int
  partId      Int
  quantity    Int?     @default(1)
  createdAt   DateTime @default(now())

  part      Part      @relation(fields: [partId], references: [id])
  equipment Equipment @relation(fields: [equipmentId], references: [id])

  @@id([equipmentId, partId])
  @@map("part_equipment")
}

// ====================
// üì¶ PRODUCTOS
// ====================

model Product {
  id            Int      @id @default(autoincrement())
  name          String   @db.VarChar(25)
  code          String?  @unique
  information   String?
  stockQuantity Int?     @default(0)
  unitPrice     Decimal? @db.Decimal(10, 2)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relaciones
  brandId Int?
  brand   Brand? @relation(fields: [brandId], references: [id])

  presentationId Int?
  presentation   Presentation? @relation(fields: [presentationId], references: [id])

  companies ProductCompany[]

  @@index([name])
  @@index([brandId])
  @@map("products")
}

// Relaciones empresa-producto extendidas
model ProductCompany {
  productId Int
  companyId Int
  price     Decimal? @db.Decimal(10, 2)
  stock     Int?     @default(0)
  createdAt DateTime @default(now())

  product Product @relation(fields: [productId], references: [id])
  company Company @relation(fields: [companyId], references: [id])

  @@id([productId, companyId])
  @@map("product_company")
}
